app-id: com.revolutionarygamesstudio.ThriveLauncher
runtime: org.freedesktop.Platform
runtime-version: '21.08'
sdk: org.freedesktop.Sdk
base: org.electronjs.Electron2.BaseApp
base-version: '21.08'
command: thrivelauncher
separate-locales: false
rename-icon: thrive-launcher
finish-args:
  - --share=network
  - --device=dri
  - --socket=x11
  - --socket=pulseaudio
  - --share=ipc
modules:
  - name: unappimage
    buildsystem: simple
    build-commands:
      - make -C squashfs-tools install INSTALL_DIR=/app/bin
    sources:
      - type: git
        url: https://github.com/refi64/unappimage
        commit: d7f86f2a0d7ec3a69211125207d5f127386b849a

  - name: p7zip
    no-autogen: true
    build-options:
    strip: true
    make-args:
      - all2
      - OPTFLAGS=-O2 -g
      - DEST_HOME=$(FLATPAK_DEST)
      - DEST_BIN=$(FLATPAK_DEST)/bin
      - DEST_SHARE=$(FLATPAK_DEST)/lib/p7zip
      - DEST_MAN=$(FLATPAK_DEST)/share/man
    make-install-args:
      - DEST_HOME=$(FLATPAK_DEST)
      - DEST_BIN=$(FLATPAK_DEST)/bin
      - DEST_SHARE=$(FLATPAK_DEST)/lib/p7zip
      - DEST_MAN=$(FLATPAK_DEST)/share/man
    sources:
      - type: archive
        url: https://github.com/jinfeihan57/p7zip/archive/v17.03.tar.gz
        sha256: bb4b9b21584c0e076e0b4b2705af0dbe7ac19d378aa7f09a79da33a5b3293187

  - name: thrive-launcher
    buildsystem: simple
    cleanup:
      - squashfs-root
    sources:
      - type: file
        url: https://github.com/Revolutionary-Games/Thrive-Launcher/releases/download/v1.3.2/Thrive-Launcher-1.3.2.AppImage
        sha256: 5b849209c84a5ca2e9d85086bd373ab7373e0505fe5a2c2f001fffa75b6e51d8
        x-checker-data:
          type: json
          url: https://api.github.com/repos/Revolutionary-Games/Thrive-Launcher/releases/latest
          version-query: .tag_name | sub("^v"; "")
          url-query: .assets[] | select(.name=="Thrive-Launcher-" + $version + ".AppImage")
            | .browser_download_url

      - type: script
        dest-filename: thrivelauncher
        commands:
          - exec zypak-wrapper /app/bin/image/thrive-launcher

      - type: file
        path: com.revolutionarygamesstudio.ThriveLauncher.appdata.xml

    build-commands:
      #Launcher script
      - install -t ${FLATPAK_DEST}/bin thrivelauncher
      # Extract launcher
      - unappimage Thrive-Launcher-1.3.1.AppImage
      # Install launcher
      - mkdir -p /app/bin/image
      - cp -r squashfs-root/* /app/bin/image/
      # Move usr directory
      - mkdir -p /app/share/icons/hicolor
      - cp -r squashfs-root/usr/share/icons/hicolor/* /app/share/icons/hicolor/
      # Install desktop file
      - install -Dm644 squashfs-root/thrive-launcher.desktop "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop"
      - desktop-file-edit --set-key="Exec" --set-value="thrivelauncher" "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop"
      - desktop-file-edit --set-key="Name" --set-value="Thrive" "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop"
      # Install app data
      - install -Dm644 com.revolutionarygamesstudio.ThriveLauncher.appdata.xml "${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.appdata.xml"
